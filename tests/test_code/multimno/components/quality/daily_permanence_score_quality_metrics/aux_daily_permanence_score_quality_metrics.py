import datetime as dt
from pyspark.sql import Row
from pyspark.sql import SparkSession
from pyspark.sql.types import (
    StructField,
    StructType,
    StringType,
    ArrayType,
    LongType,
    ShortType,
    ByteType,
    IntegerType,
    TimestampType,
)
from configparser import ConfigParser

from multimno.core.constants.columns import ColNames
from multimno.core.data_objects.silver.silver_daily_permanence_score_data_object import (
    SilverDailyPermanenceScoreDataObject,
)
from multimno.core.utils import calc_hashed_user_id, apply_schema_casting
from multimno.core.settings import CONFIG_SILVER_PATHS_KEY

DPS_AUX_SCHEMA = StructType(
    [
        StructField(ColNames.user_id, StringType(), nullable=False),
        StructField(ColNames.dps, ArrayType(StringType()), nullable=False),
        StructField(ColNames.time_slot_initial_time, TimestampType(), nullable=False),
        StructField(ColNames.time_slot_end_time, TimestampType(), nullable=False),
        StructField(ColNames.year, ShortType(), nullable=False),
        StructField(ColNames.month, ByteType(), nullable=False),
        StructField(ColNames.day, ByteType(), nullable=False),
        StructField(ColNames.user_id_modulo, IntegerType(), nullable=False),
        StructField(ColNames.id_type, StringType(), nullable=True),
    ]
)


def get_input_daily_permanence_score():
    DPS = [
        Row(
            user_id=1,
            dps=["-99"],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 10, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 11, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="unknown",
        ),
        Row(
            user_id=1,
            dps=["-99"],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 15, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 16, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="unknown",
        ),
        Row(
            user_id=1,
            dps=["-99"],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 16, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 17, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="unknown",
        ),
        Row(
            user_id=1,
            dps=["-99"],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 18, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 19, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="unknown",
        ),
        Row(
            user_id=1,
            dps=["-99"],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 20, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 21, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="unknown",
        ),
        Row(
            user_id=1,
            dps=["-99"],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 21, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 22, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="unknown",
        ),
        Row(
            user_id=2,
            dps=["-99"],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 2, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 3, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="unknown",
        ),
        Row(
            user_id=2,
            dps=["-99"],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 3, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 4, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="unknown",
        ),
        Row(
            user_id=2,
            dps=["-99"],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 4, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 5, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="unknown",
        ),
        Row(
            user_id=2,
            dps=["-99"],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 5, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 6, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="unknown",
        ),
        Row(
            user_id=2,
            dps=["-99"],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 6, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 7, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="unknown",
        ),
        Row(
            user_id=2,
            dps=["-99"],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 7, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 8, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="unknown",
        ),
        Row(
            user_id=2,
            dps=["-99"],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 10, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 11, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="unknown",
        ),
        Row(
            user_id=2,
            dps=["-99"],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 11, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 12, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="unknown",
        ),
        Row(
            user_id=2,
            dps=["-99"],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 12, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 13, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="unknown",
        ),
        Row(
            user_id=2,
            dps=["-99"],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 13, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 14, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="unknown",
        ),
        Row(
            user_id=2,
            dps=["-99"],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 14, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 15, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="unknown",
        ),
        Row(
            user_id=2,
            dps=["-99"],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 15, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 16, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="unknown",
        ),
        Row(
            user_id=2,
            dps=["-99"],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 16, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 17, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="unknown",
        ),
        Row(
            user_id=2,
            dps=["-99"],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 17, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 18, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="unknown",
        ),
        Row(
            user_id=2,
            dps=["-99"],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 18, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 19, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="unknown",
        ),
        Row(
            user_id=2,
            dps=["-99"],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 19, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 20, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="unknown",
        ),
        Row(
            user_id=2,
            dps=["-99"],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 20, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 21, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="unknown",
        ),
        Row(
            user_id=2,
            dps=["-99"],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 21, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 22, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="unknown",
        ),
        Row(
            user_id=2,
            dps=["-99"],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 22, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 23, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="unknown",
        ),
        Row(
            user_id=2,
            dps=["-99"],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 23, 0),
            time_slot_end_time=dt.datetime(2023, 1, 3, 0, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="unknown",
        ),
        Row(
            user_id=1,
            dps=[
                "fdc54c22013740684a127e84b7364b19655f92d1d25ff3d97d77c661b9beba3c",
                "efba9233ede0b04d8c012cbabafc04dd42d330bd6982c668dda43316f82e9ed7",
            ],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 9, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 10, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="grid",
        ),
        Row(
            user_id=1,
            dps=[
                "fdc54c22013740684a127e84b7364b19655f92d1d25ff3d97d77c661b9beba3c",
                "efba9233ede0b04d8c012cbabafc04dd42d330bd6982c668dda43316f82e9ed7",
            ],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 11, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 12, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="grid",
        ),
        Row(
            user_id=1,
            dps=[
                "fdc54c22013740684a127e84b7364b19655f92d1d25ff3d97d77c661b9beba3c",
                "efba9233ede0b04d8c012cbabafc04dd42d330bd6982c668dda43316f82e9ed7",
            ],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 12, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 13, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="grid",
        ),
        Row(
            user_id=1,
            dps=[
                "fdc54c22013740684a127e84b7364b19655f92d1d25ff3d97d77c661b9beba3c",
                "efba9233ede0b04d8c012cbabafc04dd42d330bd6982c668dda43316f82e9ed7",
            ],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 13, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 14, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="grid",
        ),
        Row(
            user_id=1,
            dps=[
                "fdc54c22013740684a127e84b7364b19655f92d1d25ff3d97d77c661b9beba3c",
                "efba9233ede0b04d8c012cbabafc04dd42d330bd6982c668dda43316f82e9ed7",
            ],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 14, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 15, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="grid",
        ),
        Row(
            user_id=1,
            dps=[
                "fdc54c22013740684a127e84b7364b19655f92d1d25ff3d97d77c661b9beba3c",
                "efba9233ede0b04d8c012cbabafc04dd42d330bd6982c668dda43316f82e9ed7",
            ],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 17, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 18, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="grid",
        ),
        Row(
            user_id=1,
            dps=[
                "fdc54c22013740684a127e84b7364b19655f92d1d25ff3d97d77c661b9beba3c",
                "efba9233ede0b04d8c012cbabafc04dd42d330bd6982c668dda43316f82e9ed7",
            ],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 19, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 20, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="grid",
        ),
        Row(
            user_id=1,
            dps=[
                "fdc54c22013740684a127e84b7364b19655f92d1d25ff3d97d77c661b9beba3c",
                "efba9233ede0b04d8c012cbabafc04dd42d330bd6982c668dda43316f82e9ed7",
            ],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 22, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 23, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="grid",
        ),
        Row(
            user_id=1,
            dps=[
                "fdc54c22013740684a127e84b7364b19655f92d1d25ff3d97d77c661b9beba3c",
                "efba9233ede0b04d8c012cbabafc04dd42d330bd6982c668dda43316f82e9ed7",
            ],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 23, 0),
            time_slot_end_time=dt.datetime(2023, 1, 3, 0, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="grid",
        ),
        Row(
            user_id=2,
            dps=[
                "fdc54c22013740684a127e84b7364b19655f92d1d25ff3d97d77c661b9beba3c",
                "efba9233ede0b04d8c012cbabafc04dd42d330bd6982c668dda43316f82e9ed7",
            ],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 0, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 1, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="grid",
        ),
        Row(
            user_id=2,
            dps=[
                "fdc54c22013740684a127e84b7364b19655f92d1d25ff3d97d77c661b9beba3c",
                "efba9233ede0b04d8c012cbabafc04dd42d330bd6982c668dda43316f82e9ed7",
            ],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 1, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 2, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="grid",
        ),
        Row(
            user_id=1,
            dps=[
                "3fe2f51757fd338ab8adc887fa6f4f356248d0527218ab38f8bde09b1e286f5b",
                "efba9233ede0b04d8c012cbabafc04dd42d330bd6982c668dda43316f82e9ed7",
            ],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 0, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 1, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="grid",
        ),
        Row(
            user_id=1,
            dps=[
                "3fe2f51757fd338ab8adc887fa6f4f356248d0527218ab38f8bde09b1e286f5b",
                "efba9233ede0b04d8c012cbabafc04dd42d330bd6982c668dda43316f82e9ed7",
            ],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 1, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 2, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="grid",
        ),
        Row(
            user_id=1,
            dps=[
                "3fe2f51757fd338ab8adc887fa6f4f356248d0527218ab38f8bde09b1e286f5b",
                "efba9233ede0b04d8c012cbabafc04dd42d330bd6982c668dda43316f82e9ed7",
            ],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 2, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 3, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="grid",
        ),
        Row(
            user_id=1,
            dps=[
                "3fe2f51757fd338ab8adc887fa6f4f356248d0527218ab38f8bde09b1e286f5b",
                "efba9233ede0b04d8c012cbabafc04dd42d330bd6982c668dda43316f82e9ed7",
            ],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 3, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 4, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="grid",
        ),
        Row(
            user_id=1,
            dps=[
                "3fe2f51757fd338ab8adc887fa6f4f356248d0527218ab38f8bde09b1e286f5b",
                "efba9233ede0b04d8c012cbabafc04dd42d330bd6982c668dda43316f82e9ed7",
            ],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 4, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 5, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="grid",
        ),
        Row(
            user_id=1,
            dps=[
                "3fe2f51757fd338ab8adc887fa6f4f356248d0527218ab38f8bde09b1e286f5b",
                "efba9233ede0b04d8c012cbabafc04dd42d330bd6982c668dda43316f82e9ed7",
            ],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 5, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 6, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="grid",
        ),
        Row(
            user_id=1,
            dps=[
                "3fe2f51757fd338ab8adc887fa6f4f356248d0527218ab38f8bde09b1e286f5b",
                "efba9233ede0b04d8c012cbabafc04dd42d330bd6982c668dda43316f82e9ed7",
            ],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 6, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 7, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="grid",
        ),
        Row(
            user_id=1,
            dps=[
                "3fe2f51757fd338ab8adc887fa6f4f356248d0527218ab38f8bde09b1e286f5b",
                "efba9233ede0b04d8c012cbabafc04dd42d330bd6982c668dda43316f82e9ed7",
            ],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 7, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 8, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="grid",
        ),
        Row(
            user_id=1,
            dps=["efba9233ede0b04d8c012cbabafc04dd42d330bd6982c668dda43316f82e9ed7"],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 8, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 9, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="grid",
        ),
        Row(
            user_id=2,
            dps=["efba9233ede0b04d8c012cbabafc04dd42d330bd6982c668dda43316f82e9ed7"],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 8, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 9, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="grid",
        ),
        Row(
            user_id=2,
            dps=["efba9233ede0b04d8c012cbabafc04dd42d330bd6982c668dda43316f82e9ed7"],
            time_slot_initial_time=dt.datetime(2023, 1, 2, 9, 0),
            time_slot_end_time=dt.datetime(2023, 1, 2, 10, 0),
            year=2023,
            month=1,
            day=2,
            user_id_modulo=510,
            id_type="grid",
        ),
    ]
    return DPS


def get_expected_metrics():

    res_ts = dt.datetime.now()
    rows = [
        Row(
            result_timestamp=res_ts,
            num_unknown_devices=1,
            pct_unknown_devices=50.0,
            month=1,
            day=2,
            year=2023,
        ),
    ]

    return rows


def set_input_data(spark: SparkSession, config: ConfigParser):

    input_dps = spark.createDataFrame(get_input_daily_permanence_score(), schema=DPS_AUX_SCHEMA)

    dps_do = SilverDailyPermanenceScoreDataObject(
        spark, config.get(CONFIG_SILVER_PATHS_KEY, "daily_permanence_score_data_silver")
    )

    dps_do.df = apply_schema_casting(calc_hashed_user_id(input_dps), SilverDailyPermanenceScoreDataObject.SCHEMA)

    dps_do.write()
